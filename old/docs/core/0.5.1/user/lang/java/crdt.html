<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Conflict-free Replicated Data Types · Cloudstate</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Cloudstate Documentation'/>
<link rel="canonical" href="https://cloudstate.io/docs/core/current/user/lang/java/crdt.html"/>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,700,700i&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>

<!-- OneTrust Cookies Consent Notice start -->
<script type="text/javascript">
(function(w,d,s){if(w.location.protocol!="file:"){var f=d.getElementsByTagName(s)[0],j=d.createElement(s);
j.async=true;j.src="https://cdn.cookielaw.org/consent/a14b53db-7715-45da-be81-7fd0cafc385d.js";
j.charset="UTF-8";f.parentNode.insertBefore(j,f);}})(window,document,"script");</script>
<!-- OneTrust Cookies Consent Notice end -->

<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WWL9BXX');</script>
<!-- End Google Tag Manager -->

<script type="text/javascript" src="../../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../../js/page.js"></script>
<script type="text/javascript" src="../../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/page.css"/>

<link rel="icon" type="image/x-icon" href="../../../../../../favicon.ico">
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../../index.html" >
Cloudstate Documentation
</a>
</div>
<div class="nav-version">
Version 0.5.1
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../../user/index.html" class="page">Using Cloudstate</a>
  <ul>
    <li><a href="../../../user/quickstart.html" class="page">Quickstart</a></li>
    <li><a href="../../../user/features/index.html" class="page">Overview</a>
    <ul>
      <li><a href="../../../user/features/grpc.html" class="page">gRPC descriptors</a></li>
      <li><a href="../../../user/features/eventsourced.html" class="page">Event sourcing</a></li>
      <li><a href="../../../user/features/crdts.html" class="page">Conflict-free Replicated Data Types</a></li>
      <li><a href="../../../user/features/effects.html" class="page">Forwarding and effects</a></li>
    </ul></li>
    <li><a href="../../../user/lang/index.html" class="page">Languages</a>
    <ul>
      <li><a href="../../../user/lang/javascript/index.html" class="page">JavaScript</a></li>
      <li><a href="../../../user/lang/java/index.html" class="page">Java</a></li>
      <li><a href="../../../user/lang/go/index.html" class="page">Go</a></li>
      <li><a href="../../../user/lang/kotlin/index.html" class="page">Kotlin</a></li>
      <li><a href="../../../user/lang/dart/index.html" class="page">Dart</a></li>
      <li><a href="../../../user/lang/springboot/index.html" class="page">Spring Boot</a></li>
      <li><a href="../../../user/lang/dotnet/index.html" class="page">.Net</a></li>
    </ul></li>
    <li><a href="../../../user/deployment/index.html" class="page">Deploying applications</a>
    <ul>
      <li><a href="../../../user/deployment/installing.html" class="page">Installing</a></li>
      <li><a href="../../../user/deployment/deploying.html" class="page">Deploying a stateful service</a></li>
      <li><a href="../../../user/deployment/stores/index.html" class="page">Stateful stores</a></li>
      <li><a href="../../../user/deployment/monitoring.html" class="page">Monitoring</a></li>
      <li><a href="../../../user/deployment/autoscaling.html" class="page">Autoscaling</a></li>
      <li><a href="../../../user/deployment/security.html" class="page">Security</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../../../spec/index.html" class="page">Protocol Specification</a></li>
  <li><a href="../../../developer/index.html" class="page">Content for developers of Cloudstate</a>
  <ul>
    <li><a href="../../../developer/thebuild.html" class="page">The Cloudstate Build</a></li>
    <li><a href="../../../developer/nativeimage.html" class="page">Building native images in Cloudstate</a></li>
    <li><a href="../../../developer/language-support/index.html" class="page">Language support</a>
    <ul>
      <li><a href="../../../developer/language-support/serialization.html" class="page">Cloudstate serialization convention</a></li>
    </ul></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>
<div id="lightbend-banner" class="lightbend-banner cloudstate full-width" data-category="OSS Lightbend Banner Impression" data-label="Cloudstate Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Cloudstate Banner" href="https://www.lightbend.com?r=oss-banner-cloudstate" target="_blank">
<img class="lightbend-logo" src="../../../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your apps with Lightbend [Button] - Cloudstate Banner" href="https://www.lightbend.com/lightbend-subscription?r=oss-banner-cloudstate" target="_blank">
<span>Enhance your apps with</span>
<img class="lightbend-logo" src="../../../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://akka.io" class="akka oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Akka - Logo Tag Line - Cloudstate Banner">
<img class="akka-full-color-logo" src="../../../images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
</a>
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Cloudstate Banner">
<img class="cloudflow-full-color-logo" src="../../../images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Cloudstate Banner">
<img class="lagom-full-color-logo" src="../../../images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Cloudstate Banner">
<img class="play-full-color-logo" src="../../../images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Cloudstate Banner">
<img class="scala-full-color-logo" src="../../../images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="cloudstate current">
<img class="cloudstate-full-color-logo" src="../../../images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
<span>Get developer assistance and expert support from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Cloudstate Banner" href="https://www.lightbend.com/lightbend-subscription?r=oss-banner-cloudstate" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../../../../.."><img src="../../../images/cloudstate-horizontal-white.svg" alt="Cloudstate"/></a></div>
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column site-nav-container">
<nav class="site-nav">
<div class="nav-home">
<a href="../../../index.html" >
Cloudstate Documentation
</a>
</div>
<div class="nav-version">
Version 0.5.1
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../../user/index.html" class="page">Using Cloudstate</a>
  <ul>
    <li><a href="../../../user/quickstart.html" class="page">Quickstart</a></li>
    <li><a href="../../../user/features/index.html" class="page">Overview</a>
    <ul>
      <li><a href="../../../user/features/grpc.html" class="page">gRPC descriptors</a></li>
      <li><a href="../../../user/features/eventsourced.html" class="page">Event sourcing</a></li>
      <li><a href="../../../user/features/crdts.html" class="page">Conflict-free Replicated Data Types</a></li>
      <li><a href="../../../user/features/effects.html" class="page">Forwarding and effects</a></li>
    </ul></li>
    <li><a href="../../../user/lang/index.html" class="page">Languages</a>
    <ul>
      <li><a href="../../../user/lang/javascript/index.html" class="page">JavaScript</a></li>
      <li><a href="../../../user/lang/java/index.html" class="page">Java</a></li>
      <li><a href="../../../user/lang/go/index.html" class="page">Go</a></li>
      <li><a href="../../../user/lang/kotlin/index.html" class="page">Kotlin</a></li>
      <li><a href="../../../user/lang/dart/index.html" class="page">Dart</a></li>
      <li><a href="../../../user/lang/springboot/index.html" class="page">Spring Boot</a></li>
      <li><a href="../../../user/lang/dotnet/index.html" class="page">.Net</a></li>
    </ul></li>
    <li><a href="../../../user/deployment/index.html" class="page">Deploying applications</a>
    <ul>
      <li><a href="../../../user/deployment/installing.html" class="page">Installing</a></li>
      <li><a href="../../../user/deployment/deploying.html" class="page">Deploying a stateful service</a></li>
      <li><a href="../../../user/deployment/stores/index.html" class="page">Stateful stores</a></li>
      <li><a href="../../../user/deployment/monitoring.html" class="page">Monitoring</a></li>
      <li><a href="../../../user/deployment/autoscaling.html" class="page">Autoscaling</a></li>
      <li><a href="../../../user/deployment/security.html" class="page">Security</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../../../spec/index.html" class="page">Protocol Specification</a></li>
  <li><a href="../../../developer/index.html" class="page">Content for developers of Cloudstate</a>
  <ul>
    <li><a href="../../../developer/thebuild.html" class="page">The Cloudstate Build</a></li>
    <li><a href="../../../developer/nativeimage.html" class="page">Building native images in Cloudstate</a></li>
    <li><a href="../../../developer/language-support/index.html" class="page">Language support</a>
    <ul>
      <li><a href="../../../developer/language-support/serialization.html" class="page">Cloudstate serialization convention</a></li>
    </ul></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../../index.html">Cloudstate</a></li>
  <li><a href="../../../user/index.html">Using Cloudstate</a></li>
  <li><a href="../../../user/lang/index.html">Languages</a></li>
  <li><a href="../../../user/lang/java/index.html">Java</a></li>
  <li>Conflict-free Replicated Data Types</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#conflict-free-replicated-data-types" name="conflict-free-replicated-data-types" class="anchor"><span class="anchor-link"></span></a>Conflict-free Replicated Data Types</h1>
<p>This page documents how to implement Cloudstate CRDT entities in Java. For information on what Cloudstate CRDT entities are, please read the general <a href="../../features/crdts.html">Conflict-free Replicated Data Type</a> documentation first.</p>
<p>A CRDT can be created by annotating it with the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtEntity.html" title="io.cloudstate.javasupport.crdt.CrdtEntity"><code>`@CrdtEntity`</code></a> annotation.</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L27-L28" target="_blank" title="Go to snippet source"></a><code class="language-java">@CrdtEntity
public class ShoppingCartEntity {</code></pre>
<h2><a href="#accessing-and-creating-an-entitys-crdt" name="accessing-and-creating-an-entitys-crdt" class="anchor"><span class="anchor-link"></span></a>Accessing and creating an entity&rsquo;s CRDT</h2>
<p>Each CRDT entity manages one root CRDT. That CRDT will either be supplied to the entity by the proxy when it is started, or, if no CRDT exists for the entity when it is started, it can be created by the entity using a <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtFactory.html" title="io.cloudstate.javasupport.crdt.CrdtFactory"><code>`CrdtFactory`</code></a> extending context.</p>
<p>There are multiple ways that a CRDT entity may access its CRDT. It may have the CRDT injected directly into its constructor or a command handler - the value can be wrapped in an <code>Optional</code> to distinguish between entities that have been created and CRDTs that have not yet been created. If not wrapped in <code>Optional</code>, the CRDT will be created automatically, according to its type. The CRDT can also be read from any <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtContext.html" title="io.cloudstate.javasupport.crdt.CrdtContext"><code>`CrdtContext`</code></a> via the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtContext.html#state-java.lang.Class-" title="io.cloudstate.javasupport.crdt.CrdtContext"><code>`state`</code></a> method.</p>
<p>An entity&rsquo;s CRDT can be created from the entity&rsquo;s constructor using the <code>CrdtFactory</code> methods on <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtCreationContext.html" title="io.cloudstate.javasupport.crdt.CrdtCreationContext"><code>`CrdtCreationContext`</code></a>, or using the same methods in a command handler using the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CommandContext.html" title="io.cloudstate.javasupport.crdt.CommandContext"><code>`CommandContext`</code></a>. Note that the CRDT may only be created once, and only if it hasn&rsquo;t been provided by the CloudState proxy already. Any attempt to create a CRDT when one already exists will throw an <code>IllegalStateException</code>.</p>
<p>For most use cases, simply injecting the CRDT directly into the constructor, and storing in a local field, will be the most convenient and straightforward method of using a CRDT. In our shopping cart example, we&rsquo;re going to use an <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegisterMap.html" title="io.cloudstate.javasupport.crdt.LWWRegisterMap"><code>`LWWRegisterMap`</code></a>, this shows how it may be injected:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L32-L36" target="_blank" title="Go to snippet source"></a><code class="language-java">private final LWWRegisterMap&lt;String, Shoppingcart.LineItem&gt; items;

public ShoppingCartEntity(LWWRegisterMap&lt;String, Shoppingcart.LineItem&gt; items) {
  this.items = items;
}</code></pre>
<p>In addition to the CRDT, the constructor may accept a <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtCreationContext.html" title="io.cloudstate.javasupport.crdt.CrdtCreationContext"><code>`CrdtCreationContext`</code></a>.</p>
<h2><a href="#handling-commands" name="handling-commands" class="anchor"><span class="anchor-link"></span></a>Handling commands</h2>
<p>Command handlers can be declared by annotating a method with <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CommandHandler.html" title="io.cloudstate.javasupport.crdt.CommandHandler"><code>`@CommandHandler`</code></a>. They take a context class of type <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CommandContext.html" title="io.cloudstate.javasupport.crdt.CommandContext"><code>`CommandContext`</code></a>.</p>
<p>By default, the name of the command that the method handles will be the name of the method with the first letter capitalized. So, a method called <code>getCart</code> will handle gRPC service call command named <code>GetCart</code>. This can be overridden by setting the <code>name</code> parameter on the <code>@CommandHandler</code> annotation.</p>
<p>The command handler also can take the gRPC service call input type as a parameter, to receive the command message. This is optional, sometimes it&rsquo;s not needed. For example, our <code>GetCart</code> service call doesn&rsquo;t need any information from the message, since it&rsquo;s just returning the current state as is. Meanwhile, the <code>AddItem</code> service call does need information from the message, since it needs to know the product id, description and quantity to add to the cart.</p>
<p>The return type of the command handler must be the output type for the gRPC service call, this will be sent as the reply.</p>
<p>The following shows the implementation of the <code>GetCart</code> command handler. This command handler is a read-only command handler, it doesn&rsquo;t update the CRDT, it just returns some state:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L40-L43" target="_blank" title="Go to snippet source"></a><code class="language-java">@CommandHandler
public Shoppingcart.Cart getCart() {
  return Shoppingcart.Cart.newBuilder().addAllItems(items.values()).build();
}</code></pre>
<h2><a href="#updating-a-crdt" name="updating-a-crdt" class="anchor"><span class="anchor-link"></span></a>Updating a CRDT</h2>
<p>Due to CloudState&rsquo;s <a href="../../features/crdts.html#approach-to-crdts-in-cloudstate">take in turns approach</a>, CRDTs may only be updated in command handlers and <a href="crdt.html#responding-to-stream-cancellation">stream cancellation callbacks</a>.</p>
<p>Here&rsquo;s a command handler for the <code>AddItem</code> command that adds the item to the shopping cart:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L47-L66" target="_blank" title="Go to snippet source"></a><code class="language-java">@CommandHandler
public Empty addItem(Shoppingcart.AddLineItem item, CommandContext ctx) {
  if (item.getQuantity() &lt;= 0) {
    ctx.fail(&quot;Cannot add a negative quantity of items.&quot;);
  }
  if (items.containsKey(item.getProductId())) {
    items.computeIfPresent(
        item.getProductId(),
        (id, old) -&gt; old.toBuilder().setQuantity(old.getQuantity() + item.getQuantity()).build());
  } else {
    items.put(
        item.getProductId(),
        Shoppingcart.LineItem.newBuilder()
            .setProductId(item.getProductId())
            .setName(item.getName())
            .setQuantity(item.getQuantity())
            .build());
  }
  return Empty.getDefaultInstance();
}</code></pre>
<h2><a href="#deleting-a-crdt" name="deleting-a-crdt" class="anchor"><span class="anchor-link"></span></a>Deleting a CRDT</h2>
<p>A CRDT can be deleted by invoking <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CommandContext.html#delete--" title="io.cloudstate.javasupport.crdt.CommandContext"><code>`CommandContext.delete`</code></a>. Once a CRDT is deleted, the entity will be shut down, and all subsequent commands for the entity will be rejected.</p>
<p>Caution should be taken when deleting CRDTs - the Reference Implementation of the proxy needs to maintain tombstones for each CRDT deleted, so over time, if many CRDTs are created and deleted, this will result in not just running out of memory, but increased network usage as the tombstones still need to be gossipped through the cluster for replication.</p>
<h2><a href="#streamed-command-handlers" name="streamed-command-handlers" class="anchor"><span class="anchor-link"></span></a>Streamed command handlers</h2>
<p>Streamed commands can be used to receive and publish updates to the state. If a gRPC service call has a streamed result type, the handler for that call can accept a <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/StreamedCommandContext.html" title="io.cloudstate.javasupport.crdt.StreamedCommandContext"><code>`StreamedCommandContext`</code></a>, and use that to register callbacks.</p>
<h3><a href="#responding-to-changes" name="responding-to-changes" class="anchor"><span class="anchor-link"></span></a>Responding to changes</h3>
<p>If the command handler wishes to publish changes to the stream it can register a callback with <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/StreamedCommandContext.html#onChange-java.util.function.Function-" title="io.cloudstate.javasupport.crdt.StreamedCommandContext"><code>`onChange`</code></a>, which will be invoked every time the CRDT changes.</p>
<p>The callback is then able to return a message to be sent to the client (or empty, if it wishes to send no message in response to that particular change). The callback may not modify the CRDT itself, but it may emit effects that may modify the CRDT.</p>
<p>If the shopping cart service had a <code>WatchCart</code> call, like this:</p>
<pre class="prettyprint"><code class="language-proto">rpc WatchCart(GetShoppingCart) returns (stream Cart);
</code></pre>
<p>that could be implemented like this:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L70-L76" target="_blank" title="Go to snippet source"></a><code class="language-java">@CommandHandler
public Shoppingcart.Cart watchCart(StreamedCommandContext&lt;Shoppingcart.Cart&gt; ctx) {

  ctx.onChange(subscription -&gt; Optional.of(getCart()));

  return getCart();
}</code></pre>
<h3><a href="#ending-the-stream" name="ending-the-stream" class="anchor"><span class="anchor-link"></span></a>Ending the stream</h3>
<p>The <code>onChange</code> callback can end the stream by invoking <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/SubscriptionContext.html#endStream--" title="io.cloudstate.javasupport.crdt.SubscriptionContext"><code>`endStream`</code></a> on the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/SubscriptionContext.html" title="io.cloudstate.javasupport.crdt.SubscriptionContext"><code>`SubscriptionContext`</code></a> it is passed. If it does this, it will not receive an <code>onCancel</code> callback.</p>
<h3><a href="#responding-to-stream-cancellation" name="responding-to-stream-cancellation" class="anchor"><span class="anchor-link"></span></a>Responding to stream cancellation</h3>
<p>A streamed command handler may also register an <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/StreamedCommandContext.html#onCancel-java.util.function.Consumer-" title="io.cloudstate.javasupport.crdt.StreamedCommandContext"><code>`onCancel`</code></a> callback to be notified when the stream is cancelled. The cancellation callback handler may update the CRDT. This is useful if the CRDT is being used to track connections, for example, when using <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html" title="io.cloudstate.javasupport.crdt.Vote"><code>`Vote`</code></a> CRDTs to track a user&rsquo;s online status.</p>
<h2><a href="#types-of-crdts" name="types-of-crdts" class="anchor"><span class="anchor-link"></span></a>Types of CRDTs</h2>
<p>The Cloudstate Java support library offers Java classes for each of the <a href="../../features/crdts.html#crdts-available-in-cloudstate">CRDTs available in Cloudstate</a>.</p>
<h3><a href="#counters-and-flags" name="counters-and-flags" class="anchor"><span class="anchor-link"></span></a>Counters and flags</h3>
<p><a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/GCounter.html" title="io.cloudstate.javasupport.crdt.GCounter"><code>`GCounter`</code></a>, <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/PNCounter.html" title="io.cloudstate.javasupport.crdt.PNCounter"><code>`PNCounter`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Flag.html" title="io.cloudstate.javasupport.crdt.Flag"><code>`Flag`</code></a> are available, offering operations relevant to each CRDT.</p>
<h3><a href="#vote" name="vote" class="anchor"><span class="anchor-link"></span></a>Vote</h3>
<p><a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html" title="io.cloudstate.javasupport.crdt.Vote"><code>`Vote`</code></a> is available for the Vote CRDT. The Vote CRDT allows updating the current node&rsquo;s vote using the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#vote-boolean-" title="io.cloudstate.javasupport.crdt.Vote"><code>`vote`</code></a> method, the current nodes vote can be queried using the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#getSelfVote--" title="io.cloudstate.javasupport.crdt.Vote"><code>`getSelfVote`</code></a> method.</p>
<p>For determining the result of a vote, <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#getVoters--" title="io.cloudstate.javasupport.crdt.Vote"><code>`getVoters`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#getVotesFor--" title="io.cloudstate.javasupport.crdt.Vote"><code>`getVotesFor`</code></a> can be used to check the total number of nodes, and the number of nodes that have voted for the condition, respectively. In addition, convenience methods are provided for common vote decision approaches, <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#isAtLeastOne--" title="io.cloudstate.javasupport.crdt.Vote"><code>`isAtLeastOne`</code></a> returns true if there is at least one voter for the condition, <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#isMajority--" title="io.cloudstate.javasupport.crdt.Vote"><code>`isMajority`</code></a> returns true if the number of votes for is more than half the number of voters, and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/Vote.html#isUnanimous--" title="io.cloudstate.javasupport.crdt.Vote"><code>`isAll`</code></a> returns true if the number of votes for equals the number of voters.</p>
<h3><a href="#registers" name="registers" class="anchor"><span class="anchor-link"></span></a>Registers</h3>
<p><a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`LWWRegister`</code></a> provides the LWWRegister CRDT. It can be interacted with using the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html#set-T-" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`set`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html#get--" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`get`</code></a> methods. If you wish to use a custom clock, you can use the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html#set-T-io.cloudstate.javasupport.crdt.LWWRegister.Clock-long-" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`set`</code></a> overload that allows passing a custom clock and custom clock value.</p><div class="callout note "><div class="callout-title">Important</div>
<p>Direct mutations to <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`LWWRegister`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegisterMap.html" title="io.cloudstate.javasupport.crdt.LWWRegisterMap"><code>`LWWRegisterMap`</code></a> values will not be replicated to other nodes, only mutations triggered through using the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegister.html#set-T-" title="io.cloudstate.javasupport.crdt.LWWRegister"><code>`set`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegisterMap.html#put-K-V-" title="io.cloudstate.javasupport.crdt.LWWRegisterMap"><code>`put`</code></a> methods will be replicated. Hence, the following update will not be replicated:</p>
<pre class="prettyprint"><code class="language-java">myLwwRegister.get().setSomeField(&quot;foo&quot;);
</code></pre>
<p>This update however will be replicated:</p>
<pre class="prettyprint"><code class="language-java">MyValue myValue = myLwwRegister.get();
myValue.setSomeField(&quot;foo&quot;);
myLwwRegister.set(myValue);
</code></pre>
<p>In general, we recommend that these values be immutable, as this will prevent accidentally mutating without realising the update won&rsquo;t be applied. If using protobufs as values, this will be straightforward, since compiled protobuf classes are immutable.</p></div>
<h3><a href="#sets-and-maps" name="sets-and-maps" class="anchor"><span class="anchor-link"></span></a>Sets and Maps</h3>
<p>Cloudstate Java support provides <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/GSet.html" title="io.cloudstate.javasupport.crdt.GSet"><code>`GSet`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/ORSet.html" title="io.cloudstate.javasupport.crdt.ORSet"><code>`ORSet`</code></a> that implement the <code>java.util.Set</code> interface, and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/ORMap.html" title="io.cloudstate.javasupport.crdt.ORMap"><code>`ORMap`</code></a> that implements the <code>java.util.Map</code>. However, not all operations are implemented - <code>GSet</code> doesn&rsquo;t support any removal operations, and <code>ORMap</code> does not support any operations that would replace an existing value in the map.</p>
<p>To insert a value into an <code>ORMap</code>, you should use the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/ORMap.html#getOrCreate-K-java.util.function.Function-" title="io.cloudstate.javasupport.crdt.ORMap"><code>`getOrCreate`</code></a> method. The passed in callback will give you a <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/CrdtFactory.html" title="io.cloudstate.javasupport.crdt.CrdtFactory"><code>`CrdtFactory`</code></a> that you can use to create the CRDT value that you wish to use.</p><div class="callout note "><div class="callout-title">Important</div>
<p>With all maps and sets, map keys and set values must be immutable. Cloudstate ignores the individual mutation of the key or value (not replicated to other nodes). Furthermore, their serialized form must be stable. The Cloudstate proxy uses the serialized form of the values to track changes in the set or map. If the same value serializes to two different sets of bytes on different occasions, they will be treated as different elements in the set or map.</p>
<p>This is particularly relevant when using protobufs. The ordering of map entries in a serialized protobuf is undefined, and very often will be different for two equal maps. Hence, maps should never be used as keys in <code>ORMap</code> or as values in <code>GSet</code>, <code>ORSet</code>. For the rest of the protobuf specification, while no guarantees are made on the stability by the protobuf specification itself, the Java libraries do produce stable orderings of fields and stable output of non-map values. Care should be taken when changing the protobuf structure. Many changes, that are backwards compatible from a protobuf standpoint, do not necessarily translate into stable serializations.</p>
<p>If using JSON serialization, it is recommended that you explicitly define the field ordering using Jackson&rsquo;s <code>@JsonPropertyOrder</code> annotation, and as with protobufs, never use <code>Map</code> or <code>Set</code> in your JSON objects since the ordering of those is not stable.</p></div>
<p>Some wrapper classes are also provided for ORMap. These provide more convenient APIs for working with values of particular CRDT types. They are:</p>
<dl>
  <dt><a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/LWWRegisterMap.html" title="io.cloudstate.javasupport.crdt.LWWRegisterMap"><code>`LWWRegisterMap`</code></a></dt>
  <dd>A map of LWWRegister values. This exposes the LWWRegister values as values directly in the map.</dd>
  <dt><a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/PNCounterMap.html" title="io.cloudstate.javasupport.crdt.PNCounterMap"><code>`PNCounterMap`</code></a></dt>
  <dd>A map of PNCounter values. This exposes the current value of the PNCounters directly as values in the map, and offers <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/PNCounterMap.html#increment-java.lang.Object-long-" title="io.cloudstate.javasupport.crdt.PNCounterMap"><code>`increment`</code></a> and <a href="../../../user/lang/java/api/io/cloudstate/javasupport/crdt/PNCounterMap.html#decrement-java.lang.Object-long-" title="io.cloudstate.javasupport.crdt.PNCounterMap"><code>`decrement`</code></a> methods to update the values.</dd>
</dl>
<h2><a href="#registering-the-entity" name="registering-the-entity" class="anchor"><span class="anchor-link"></span></a>Registering the entity</h2>
<p>Once you&rsquo;ve created your entity, you can register it with the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/CloudState.html" title="io.cloudstate.javasupport.CloudState"><code>`CloudState`</code></a> server, by invoking the <a href="../../../user/lang/java/api/io/cloudstate/javasupport/CloudState.html#registerCrdtEntity-java.lang.Class-com.google.protobuf.Descriptors.ServiceDescriptor-com.google.protobuf.Descriptors.FileDescriptor...-" title="io.cloudstate.javasupport.CloudState"><code>`registerCrdtEntity`</code></a> method. In addition to passing your entity class and service descriptor, if you use protobuf for serialization and any protobuf message definitions are missing from your service descriptor (they are not declared directly in the file, nor as dependencies), then you&rsquo;ll need to pass those protobuf descriptors as well.</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/test/java/docs/user/crdt/ShoppingCartEntity.java#L80-L86" target="_blank" title="Go to snippet source"></a><code class="language-java">public static void main(String... args) {
  new CloudState()
      .registerCrdtEntity(
          ShoppingCartEntity.class,
          Shoppingcart.getDescriptor().findServiceByName(&quot;ShoppingCartService&quot;))
      .start();
}</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/cloudstateio/cloudstate/tree/v0.5.1/docs/src/main/paradox/user/lang/java/crdt.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../../../user/lang/java/effects.html">Forwarding and effects</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../../user/lang/java/crdt.html#conflict-free-replicated-data-types" class="header">Conflict-free Replicated Data Types</a>
  <ul>
    <li><a href="../../../user/lang/java/crdt.html#accessing-and-creating-an-entitys-crdt" class="header">Accessing and creating an entity&rsquo;s CRDT</a></li>
    <li><a href="../../../user/lang/java/crdt.html#handling-commands" class="header">Handling commands</a></li>
    <li><a href="../../../user/lang/java/crdt.html#updating-a-crdt" class="header">Updating a CRDT</a></li>
    <li><a href="../../../user/lang/java/crdt.html#deleting-a-crdt" class="header">Deleting a CRDT</a></li>
    <li><a href="../../../user/lang/java/crdt.html#streamed-command-handlers" class="header">Streamed command handlers</a>
    <ul>
      <li><a href="../../../user/lang/java/crdt.html#responding-to-changes" class="header">Responding to changes</a></li>
      <li><a href="../../../user/lang/java/crdt.html#ending-the-stream" class="header">Ending the stream</a></li>
      <li><a href="../../../user/lang/java/crdt.html#responding-to-stream-cancellation" class="header">Responding to stream cancellation</a></li>
    </ul></li>
    <li><a href="../../../user/lang/java/crdt.html#types-of-crdts" class="header">Types of CRDTs</a>
    <ul>
      <li><a href="../../../user/lang/java/crdt.html#counters-and-flags" class="header">Counters and flags</a></li>
      <li><a href="../../../user/lang/java/crdt.html#vote" class="header">Vote</a></li>
      <li><a href="../../../user/lang/java/crdt.html#registers" class="header">Registers</a></li>
      <li><a href="../../../user/lang/java/crdt.html#sets-and-maps" class="header">Sets and Maps</a></li>
    </ul></li>
    <li><a href="../../../user/lang/java/crdt.html#registering-the-entity" class="header">Registering the entity</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<a href="../../../../../.."><img src="../../../images/cloudstate-stacked-white.svg"></a>
<p>© Cloudstate <script>document.write(new Date().getFullYear());</script> | <a href="../../../../../../privacy/">Privacy Policy</a> | <a class="optanon-toggle-display">Cookie Settings</a></p>

</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../../js/magellan.js"></script>

<style type="text/css">@import "../../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>


</html>
